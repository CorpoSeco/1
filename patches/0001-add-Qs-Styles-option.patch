From 38977131fe6332ae72771b2f524f9965d37a4a25 Mon Sep 17 00:00:00 2001
From: TheAtt1la <alittauwu@gmail.com>
Date: Sun, 5 Mar 2023 21:59:47 -0300
Subject: [PATCH] add Qs Styles option

---
 app/src/main/java/me/phh/treble/app/Custom.kt    | 12 +++++++++++-
 .../main/java/me/phh/treble/app/CustomSettings.kt    |  9 +++++++++
 .../src/main/java/me/phh/treble/app/OverlayPicker.kt |  6 ++++++
 app/src/main/res/values/pref_custom.xml          |  7 +++++++
 app/src/main/res/xml/pref_custom.xml             |  6 ++++++
 5 files changed, 39 insertions(+), 1 deletion(-)

diff --git a/app/src/main/java/me/phh/treble/app/Custom.kt b/app/src/main/java/me/phh/treble/app/Custom.kt
index 5e51c0b..f524cab 100644
--- a/app/src/main/java/me/phh/treble/app/Custom.kt
+++ b/app/src/main/java/me/phh/treble/app/Custom.kt
@@ -43,6 +43,16 @@ object Custom: EntryStartup {
                     OverlayPicker.setOverlayEnabled(value, true)
                 }
             }
+            CustomSettings.qsStyles -> {
+                val value = sp.getString(key, "")
+                val qsStylesOverlays = OverlayPicker.getThemeOverlays(OverlayPicker.ThemeOverlay.QsStyles)
+                qsStylesOverlays
+                        .filter { it.packageName != value }
+                        .forEach { OverlayPicker.setOverlayEnabled(it.packageName, false) }
+                if (!value.isNullOrEmpty()) {
+                    OverlayPicker.setOverlayEnabled(value, true)
+                }
+            }
             CustomSettings.iconPack -> {
                 val value = sp.getString(key, "")
                 val iconPackOverlays = OverlayPicker.getThemeOverlays(OverlayPicker.ThemeOverlay.IconPack)                    
@@ -57,7 +67,7 @@ object Custom: EntryStartup {
             }
         }
     }
-
+}
     override fun startup(ctxt: Context) {
         if (!CustomSettings.enabled()) return
 
diff --git a/app/src/main/java/me/phh/treble/app/CustomSettings.kt b/app/src/main/java/me/phh/treble/app/CustomSettings.kt
index 997f8ea..0922b69 100644
--- a/app/src/main/java/me/phh/treble/app/CustomSettings.kt
+++ b/app/src/main/java/me/phh/treble/app/CustomSettings.kt
@@ -8,6 +8,7 @@ object CustomSettings : Settings {
     val accentColor = "key_custom_accent_color"
     val iconShape = "key_custom_icon_shape"
     val fontFamily = "key_custom_font_family"
+    val fontFamily = "key_custom_qs_styles"
     val iconPack = "key_custom_icon_pack"
 
     override fun enabled() = true
@@ -46,6 +47,14 @@ class CustomSettingsFragment : SettingsFragment() {
         fontFamilyPref.setEntries(fontFamilyEntries.toTypedArray())
         fontFamilyPref.setEntryValues(fontFamilyValues.toTypedArray())
 
+        val qsStylesPref = findPreference<ListPreference>(CustomSettings.qsStyles)!!
+        val qsStylesOverlays = OverlayPicker.getThemeOverlays(OverlayPicker.ThemeOverlay.QsStyles)
+        val qsStylesEntries = listOf("Default") + qsStylesOverlays.map { getTargetName(it.packageName) }
+        val qsStylesValues = listOf("") + qsStylesOverlays.map { it.packageName }
+
+        qsStylesPref.setEntries(qsStylesEntries.toTypedArray())
+        qsStylesPref.setEntryValues(qsStylesValues.toTypedArray())
+
         val iconPackPref = findPreference<ListPreference>(CustomSettings.iconPack)!!
         val iconPackOverlays = OverlayPicker.getThemeOverlays(OverlayPicker.ThemeOverlay.IconPack)
         var iconPackMap = hashMapOf<String, String>()
diff --git a/app/src/main/java/me/phh/treble/app/OverlayPicker.kt b/app/src/main/java/me/phh/treble/app/OverlayPicker.kt
index eef5186..50c31ad 100644
--- a/app/src/main/java/me/phh/treble/app/OverlayPicker.kt
+++ b/app/src/main/java/me/phh/treble/app/OverlayPicker.kt
@@ -20,6 +20,7 @@ object OverlayPicker: EntryStartup {
         AccentColor,
         IconShape,
         FontFamily,
+        QsStyles,
         IconPack
     }
 
@@ -48,6 +49,11 @@ object OverlayPicker: EntryStartup {
                     it.targetPackageName == "android" &&
                     it.packageName.startsWith("com.android.theme.font.")
                 }
+             ThemeOverlay.QsStyles ->
+                return overlays.filter {
+                    it.targetPackageName == "com.android.systemui" &&
+                    it.packageName.startsWith("com.android.system.qs.")
+                }
             ThemeOverlay.IconPack -> {
                 return overlays.filter {
                     it.packageName.startsWith("com.android.theme.icon_pack.")
diff --git a/app/src/main/res/values/pref_custom.xml b/app/src/main/res/values/pref_custom.xml
index ac2a9b8..ce1cfa7 100644
--- a/app/src/main/res/values/pref_custom.xml
+++ b/app/src/main/res/values/pref_custom.xml
@@ -27,4 +27,11 @@
     <array name="pref_custom_font_family_values">
 	    <item>""</item>
     </array>
+
+    <array name="pref_custom_qs_styles">
+	    <item>"Default"</item>
+    </array>
+    <array name="pref_custom_qs_styles_values">
+	    <item>""</item>
+    </array>
 </resources>
diff --git a/app/src/main/res/xml/pref_custom.xml b/app/src/main/res/xml/pref_custom.xml
index 7c28250..8d787ca 100644
--- a/app/src/main/res/xml/pref_custom.xml
+++ b/app/src/main/res/xml/pref_custom.xml
@@ -32,5 +32,11 @@
             android:entryValues="@array/pref_custom_font_family_values"
             android:key="key_custom_font_family"
 		android:title="Font family" />
+    <ListPreference
+		android:defaultValue=""
+            android:entries="@array/pref_custom_qs_styles"
+            android:entryValues="@array/pref_custom_qs_styles_values"
+            android:key="key_custom_qs_styles"
+		android:title="QS Styles" />
     </PreferenceCategory>
 </PreferenceScreen>
-- 
2.38.1

